<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clipping de Prensa - Pesca</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="index.css">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <!-- Navigation / Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-section">
                    <img src="header_pesca.png" alt="Logo Pesca" class="header-logo">
                    <div class="header-title">
                        <h1>Clipping de Prensa</h1>
                        <span class="subtitle">Monitor de noticias del sector pesquero en Chile</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="manageEmailsBtn" class="btn btn-secondary">
                        <i class="fa-solid fa-envelope"></i> Suscripciones
                    </button>
                    <button id="scrapeBtn" class="btn btn-primary">
                        <i class="fa-solid fa-rotate"></i> <span class="btn-text">Actualizar</span>
                    </button>
                </div>
            </div>
            <div id="status-bar" class="status-bar"></div>
        </header>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Slider Section -->
            <div class="slider-container" id="slider-container">
                <div class="slides-wrapper" id="slides-wrapper">
                    <!-- Slides injected by JS -->
                </div>
                <button class="slider-btn prev-btn" id="prevBtn"><i class="fa-solid fa-chevron-left"></i></button>
                <button class="slider-btn next-btn" id="nextBtn"><i class="fa-solid fa-chevron-right"></i></button>
                <div class="slider-dots" id="slider-dots"></div>
            </div>

            <h2 class="section-title">Últimas Noticias</h2>

            <div id="loading" class="loading-state">
                <div class="spinner"></div>
                <p>Cargando lo último del sector...</p>
            </div>

            <div id="dashboard" class="news-grid">
                <!-- Articles will be injected here -->
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>&copy; 2025 Clipping de Prensa - Pesca & Acuicultura</p>
        </footer>
    </div>

    <!-- Email Management Modal -->
    <div id="emailModal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header">
                <h3>Gestionar Suscripciones</h3>
                <button id="closeModalBtn" class="btn-icon"><i class="fa-solid fa-xmark"></i></button>
            </header>
            <div class="modal-body">
                <p class="modal-description">Recibe el resumen diario de noticias en tu correo.</p>

                <div class="input-group">
                    <input type="email" id="emailInput" placeholder="nombre@correo.com" class="form-input">
                    <button id="addEmailBtn" class="btn btn-primary">Suscribir</button>
                </div>

                <div class="subscribers-list-container">
                    <h4>Suscriptores Activos</h4>
                    <ul id="recipientList" class="recipient-list">
                        <!-- List items injected here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dashboardDiv = document.getElementById('dashboard');
        const scrapeBtn = document.getElementById('scrapeBtn');
        const statusBar = document.getElementById('status-bar'); // Changed from statusSpan
        const loadingDiv = document.getElementById('loading');

        // Email UI elements
        const manageEmailsBtn = document.getElementById('manageEmailsBtn');
        const emailModal = document.getElementById('emailModal');
        const emailInput = document.getElementById('emailInput');
        const addEmailBtn = document.getElementById('addEmailBtn');
        const recipientList = document.getElementById('recipientList');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Toggle Modal
        manageEmailsBtn.addEventListener('click', () => {
            emailModal.classList.add('active'); // Use class for animation
            loadRecipients();
        });

        closeModalBtn.addEventListener('click', () => {
            emailModal.classList.remove('active');
        });

        // Close on click outside
        emailModal.addEventListener('click', (e) => {
            if (e.target === emailModal) {
                emailModal.classList.remove('active');
            }
        });

        // Load Recipients
        async function loadRecipients() {
            try {
                recipientList.innerHTML = '<li class="loading-item">Cargando...</li>';
                const res = await fetch('/api/recipients');
                const recipients = await res.json();
                renderRecipients(recipients);
            } catch (err) {
                console.error('Error loading recipients:', err);
                recipientList.innerHTML = '<li class="error-item">Error al cargar suscriptores</li>';
            }
        }

        // Render List
        function renderRecipients(list) {
            recipientList.innerHTML = '';
            if (list.length === 0) {
                recipientList.innerHTML = '<li class="empty-item">No hay suscriptores activos.</li>';
                return;
            }
            list.forEach(email => {
                const li = document.createElement('li');
                li.className = 'recipient-item';
                li.innerHTML = `
                    <span class="recipient-email">${email}</span>
                    <button onclick="removeRecipient('${email}')" class="btn-delete" title="Eliminar">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                recipientList.appendChild(li);
            });
        }

        // Add Recipient
        addEmailBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            if (!email) return;

            try {
                addEmailBtn.disabled = true;
                addEmailBtn.innerText = '...';

                const res = await fetch('/api/recipients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (data.success) {
                    emailInput.value = '';
                    renderRecipients(data.recipients);
                } else {
                    alert(data.error);
                }
            } catch (err) {
                console.error(err);
                alert('Error de conexión');
            } finally {
                addEmailBtn.disabled = false;
                addEmailBtn.innerText = 'Suscribir';
            }
        });

        // Remove Recipient (Global)
        window.removeRecipient = async (email) => {
            if (!confirm(`¿Eliminar a ${email}?`)) return;
            try {
                const res = await fetch('/api/recipients', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (data.success) {
                    renderRecipients(data.recipients);
                }
            } catch (err) {
                console.error(err);
            }
        };

        const ORDERED_CATEGORIES = [
            'Pesca Artesanal',
            'Pesca Industrial',
            'Ley de Pesca',
            'Sector Pesquero',
            'Cultivos y Áreas de Manejo',
            'Pais y Sector Empresarial',
            'Salmoneras',
            'Innovación Acuícola',
            'Otros'
        ];

        async function loadArticles() {
            loadingDiv.style.display = 'flex'; // Flex for centering
            dashboardDiv.innerHTML = '';
            statusBar.textContent = '';

            try {
                console.log('Fetching articles...');
                const res = await fetch('/api/articles');
                console.log('Response received, status:', res.status);

                if (!res.ok) throw new Error(`HTTP Error ${res.status}`);

                const articles = await res.json();
                console.log('Articles parsed:', articles.length);

                if (articles.length === 0) {
                    dashboardDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fa-regular fa-newspaper"></i>
                            <p>No hay noticias almacenadas.</p>
                            <button onclick="document.getElementById('scrapeBtn').click()" class="btn btn-link">Actualizar ahora</button>
                        </div>
                    `;
                    return;
                }

                // Group by category
                const grouped = {};
                articles.forEach(art => {
                    const cat = art.category || 'Otros';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push(art);
                });

                // Render in order
                ORDERED_CATEGORIES.forEach(cat => {
                    const catArticles = grouped[cat];
                    if (catArticles && catArticles.length > 0) {
                        // 1. Sort by date desc (Newest first)
                        catArticles.sort((a, b) => new Date(b.date) - new Date(a.date));

                        const section = document.createElement('section');
                        section.className = 'category-section';

                        const header = document.createElement('div');
                        header.className = 'category-header';
                        header.innerHTML = `<h3>${cat}</h3><span class="badge">${catArticles.length}</span>`;
                        section.appendChild(header);

                        const articlesContainer = document.createElement('div');
                        articlesContainer.className = 'category-articles';

                        // 2. Split into visible and hidden
                        const visibleArticles = catArticles.slice(0, 6);
                        const hiddenArticles = catArticles.slice(6);

                        // Helper to Create Card
                        const createCard = (art) => {
                            const artCard = document.createElement('article');
                            artCard.className = 'news-card';

                            // Format date
                            const dateObj = new Date(art.date);
                            const dateStr = dateObj.toLocaleDateString('es-CL', { day: 'numeric', month: 'short' });

                            // Domain extraction
                            let domain = art.source || 'Fuente desconocida';
                            try {
                                if (art.url) {
                                    const urlObj = new URL(art.url);
                                    domain = urlObj.hostname.replace('www.', '');
                                }
                            } catch (e) { }

                            artCard.innerHTML = `
                                <div class="card-meta">
                                    <span class="card-source">${domain}</span>
                                    <span class="card-date">${dateStr}</span>
                                </div>
                                <h4 class="card-title"><a href="${art.url}" target="_blank">${art.title}</a></h4>
                                <p class="card-summary">${art.summary || ''}</p>
                                <div class="card-actions">
                                    <a href="${art.url}" target="_blank" class="read-more">Leer nota <i class="fa-solid fa-arrow-right-long"></i></a>
                                </div>
                            `;
                            return artCard;
                        };

                        // Render Visible
                        visibleArticles.forEach(art => {
                            articlesContainer.appendChild(createCard(art));
                        });

                        // Render Hidden (if any)
                        if (hiddenArticles.length > 0) {
                            const hiddenContainer = document.createElement('div');
                            hiddenContainer.className = 'hidden-articles';
                            hiddenContainer.style.display = 'none'; // Start hidden

                            hiddenArticles.forEach(art => {
                                hiddenContainer.appendChild(createCard(art));
                            });
                            articlesContainer.appendChild(hiddenContainer);

                            // 3. Show More Button
                            const btnContainer = document.createElement('div');
                            btnContainer.className = 'show-more-container';
                            btnContainer.style.textAlign = 'center';
                            btnContainer.style.marginTop = '1rem';

                            const showMoreBtn = document.createElement('button');
                            showMoreBtn.className = 'btn btn-secondary btn-sm';
                            showMoreBtn.innerHTML = `Leer más noticias <i class="fa-solid fa-chevron-down"></i>`;

                            showMoreBtn.onclick = () => {
                                const isHidden = hiddenContainer.style.display === 'none';
                                if (isHidden) {
                                    hiddenContainer.style.display = 'grid'; // Use grid to match parent layout if needed, or 'contents'/'block' depending on CSS. 
                                    // Actually .category-articles usually has grid. 
                                    // If we use 'contents', it flattens. If 'grid', it needs columns.
                                    // Best to make hiddenContainer use grid-template-columns too or subgrid.
                                    // Simpler: use 'contents' if supported or just append items to parent?
                                    // Re-appending is cleaner.
                                    // Let's just make the hiddenContainer display: contents to inherit grid.
                                    hiddenContainer.style.display = 'contents';
                                    showMoreBtn.innerHTML = `Mostrar menos <i class="fa-solid fa-chevron-up"></i>`;
                                } else {
                                    hiddenContainer.style.display = 'none';
                                    showMoreBtn.innerHTML = `Leer más noticias <i class="fa-solid fa-chevron-down"></i>`;
                                    // Scroll back to top of section? Optional.
                                }
                            };

                            btnContainer.appendChild(showMoreBtn);
                            section.appendChild(articlesContainer); // Append container first
                            section.appendChild(btnContainer);      // Then button
                        } else {
                            section.appendChild(articlesContainer);
                        }

                        dashboardDiv.appendChild(section);
                    }
                });

            } catch (err) {
                console.error(err);
                dashboardDiv.innerHTML = `<div class="error-state">Error cargando noticias: ${err.message}</div>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        scrapeBtn.addEventListener('click', async () => {
            const btnText = scrapeBtn.querySelector('.btn-text');
            const originalText = btnText.innerText;
            const icon = scrapeBtn.querySelector('i');

            // Set loading state
            btnText.innerText = 'Iniciando...';
            icon.classList.add('fa-spin');
            scrapeBtn.disabled = true;
            statusBar.innerHTML = '';

            try {
                // Background scrape returns 202 immediately
                const res = await fetch('/api/scrape', { method: 'POST' });

                if (res.status === 202) {
                    // Success (Async)
                    statusBar.innerHTML = `<div class="status-msg success"><i class="fa-solid fa-clock"></i> Actualización iniciada en segundo plano. Tomará unos minutos.</div>`;

                    // Keep message for longer since it's a long process
                    setTimeout(() => {
                        statusBar.innerHTML = '';
                    }, 10000);

                } else if (res.status === 409) {
                    // Already running
                    statusBar.innerHTML = `<div class="status-msg warning"><i class="fa-solid fa-triangle-exclamation"></i> Ya hay una actualización en curso.</div>`;
                    setTimeout(() => statusBar.innerHTML = '', 5000);
                } else {
                    // Other success (sync) or error?
                    const data = await res.json();
                    statusBar.innerHTML = `<div class="status-msg success"><i class="fa-solid fa-check"></i> Listo. ${data.newArticles || 0} nuevas.</div>`;
                    setTimeout(() => statusBar.innerHTML = '', 5000);
                    loadArticles();
                }

            } catch (err) {
                statusBar.innerHTML = `<div class="status-msg error"><i class="fa-solid fa-triangle-exclamation"></i> Error al conectar.</div>`;
            } finally {
                // Re-enable button immediately as the request finished fast
                scrapeBtn.disabled = false;
                btnText.innerText = originalText;
                icon.classList.remove('fa-spin');
            }
        });

        // Load on start
        loadArticles();

        // --- SLIDER LOGIC ---
        const sliderContainer = document.getElementById('slider-container');
        const slidesWrapper = document.getElementById('slides-wrapper');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const dotsContainer = document.getElementById('slider-dots');

        let slideIndex = 0;
        let slideInterval;
        let slidesData = [];

        async function initSlider() {
            try {
                const res = await fetch('slider-config.json');
                slidesData = await res.json();

                if (slidesData.length === 0) {
                    sliderContainer.style.display = 'none';
                    return;
                }

                renderSlides();
                startSlider();
            } catch (err) {
                console.error('Error loading slider config:', err);
                sliderContainer.style.display = 'none';
            }
        }

        function renderSlides() {
            slidesWrapper.innerHTML = '';
            dotsContainer.innerHTML = '';

            slidesData.forEach((slide, index) => {
                // Create Slide
                const slideDiv = document.createElement('div');
                slideDiv.className = 'slide';

                if (slide.linkUrl && slide.linkUrl !== '#') {
                    slideDiv.onclick = () => window.open(slide.linkUrl, '_blank');
                    slideDiv.style.cursor = 'pointer';
                    slideDiv.title = `Ir a ${slide.linkUrl}`;
                } else {
                    slideDiv.style.cursor = 'default';
                }

                slideDiv.innerHTML = `
                    <img src="${slide.imageUrl}" alt="${slide.altText || 'Slide image'}">
                    <div class="slide-caption">${slide.altText || ''}</div>
                `;
                slidesWrapper.appendChild(slideDiv);

                // Create Dot
                const dot = document.createElement('div');
                dot.className = index === 0 ? 'dot active' : 'dot';
                dot.addEventListener('click', () => goToSlide(index));
                dotsContainer.appendChild(dot);
            });
        }

        function updateSlider() {
            slidesWrapper.style.transform = `translateX(-${slideIndex * 100}%)`;

            // Update dots
            const dots = document.querySelectorAll('.dot');
            dots.forEach((dot, idx) => {
                dot.className = idx === slideIndex ? 'dot active' : 'dot';
            });
        }

        function nextSlide() {
            slideIndex = (slideIndex + 1) % slidesData.length;
            updateSlider();
        }

        function prevSlide() {
            slideIndex = (slideIndex - 1 + slidesData.length) % slidesData.length;
            updateSlider();
        }

        function goToSlide(index) {
            slideIndex = index;
            updateSlider();
            resetTimer();
        }

        function startSlider() {
            if (slidesData.length > 1) {
                slideInterval = setInterval(nextSlide, 5000); // 5 seconds
            } else {
                // Hide nav if only 1 slide
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                dotsContainer.style.display = 'none';
            }
        }

        function resetTimer() {
            clearInterval(slideInterval);
            startSlider();
        }

        // Event Listeners for Nav
        nextBtn.addEventListener('click', () => {
            nextSlide();
            resetTimer();
        });

        prevBtn.addEventListener('click', () => {
            prevSlide();
            resetTimer();
        });

        // Initialize Slider
        initSlider();
    </script>
</body>

</html>